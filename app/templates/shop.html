{% extends "index.html" %}

{% block content %}
<style>
  .shop-container {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    padding: 20px;
  }
  .category {
    background: white;
    border-radius: 10px;
    padding: 15px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }
  .category h2 {
    border-bottom: 1px solid #eee;
    padding-bottom: 10px;
  }
  .item {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px dashed #eee;
  }
  .item button {
    background: #4CAF50;
    color: white;
    border: none;
    padding: 3px 8px;
    border-radius: 3px;
    cursor: pointer;
  }
  .item button:disabled {
    background: #ccc;
  }
  .currency-display {
    text-align: center;
    font-size: 1.5em;
    margin: 10px 0;
  }
</style>

<div class="currency-display">
  Coins: <span id="currency">{{ current_user.currency }}</span>
</div>

<div class="shop-container" id="shop-container">
  <!-- Will be populated by JavaScript -->
  Loading shop...
</div>

<script>
  async function loadShop() {
    const response = await fetch('/api/store/items');
    const data = await response.json();

    let html = '';
    for (const [category, items] of Object.entries(data)) {
      if (category === 'currency') continue;

      html += `<div class="category">
        <h2>${category.charAt(0).toUpperCase() + category.slice(1)}</h2>`;

      for (const [item, price] of Object.entries(items)) {
        const canAfford = price <= data.currency;
        html += `<div class="item">
          <span>${item.replace('_', ' ')} (${price} coins)</span>
          <button onclick="buyItem('${category}', '${item}', ${price})"
                  ${canAfford ? '' : 'disabled'}>
            Buy
          </button>
        </div>`;
      }

      html += `</div>`;
    }

    document.getElementById('shop-container').innerHTML = html;
    document.getElementById('currency').textContent = data.currency;
  }

  async function buyItem(type, name, price) {
    const response = await fetch('/api/store/buy', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token() }}'
      },
      body: JSON.stringify({ type, name })
    });

    const result = await response.json();
    if (result.success) {
      alert(`You bought a ${name.replace('_', ' ')}!`);
      loadShop(); // Refresh the shop display
    } else {
      alert(result.error || "Purchase failed");
    }
  }

  // Load shop when page opens
  loadShop();
</script>
{% endblock %}