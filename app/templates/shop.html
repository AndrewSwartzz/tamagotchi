{% extends "index.html" %}
{% block content %}
<h2>Pet Shop</h2>
<p>Your Balance: <span id="currency">{{ current_user.currency }}</span></p>

<div id="shop-items">
    <h3>Toys</h3>
    <ul id="toys-list"></ul>

    <h3>Hats</h3>
    <ul id="hats-list"></ul>

    <h3>Collars</h3>
    <ul id="collars-list"></ul>
</div>

<script>
const csrfToken = document.querySelector('meta[name="csrf-token"]').content;

function loadShopItems() {
    fetch('/api/shop/items')
        .then(res => res.json())
        .then(data => {
            ['toys', 'hats', 'collars'].forEach(category => {
                const list = document.getElementById(`${category}-list`);
                list.innerHTML = '';
                for (const [key, item] of Object.entries(data[category])) {
                    const li = document.createElement('li');
                    li.innerHTML = `${item.displayName} - ${item.price} coins
                        <button onclick="buyItem('${category}', '${key}')">Buy</button>`;
                    list.appendChild(li);
                }
            });
        });
}

function buyItem(category, item) {
    fetch('/api/shop/buy', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken  // Add CSRF token to headers
        },
        credentials: 'include',  // Important for session cookies
        body: JSON.stringify({ category, item })
    })
    .then(res => {
        if (!res.ok) {
            throw new Error('Network response was not ok');
        }
        return res.json();
    })
    .then(data => {
        if (data.success) {
            alert(data.message);
            document.getElementById('currency').innerText = data.currency;
            loadShopItems();  // Refresh the shop items
        } else {
            alert(data.error || 'Failed to purchase item.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred. Please try again.');
    });
}

document.addEventListener('DOMContentLoaded', loadShopItems);
</script>
{% endblock %}
